{% extends 'base.html' %}

{% block title %}{% if is_new %}新建报销单{% else %}编辑报销单{% endif %} - 报销神表{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h2>{% if is_new %}填写报销单{% else %}编辑报销单{% endif %}</h2>
        {% if not is_new and reimbursement.status == 'REJECTED' %}
        <div class="alert alert-warning">
            <strong>此报销单已被驳回</strong>。请根据审核意见修改后重新提交。
            {% if reimbursement.reviewer_note %}
            <br><strong>审核意见：</strong>{{ reimbursement.reviewer_note }}
            {% endif %}
        </div>
        {% endif %}
        <hr>
        
        {% if form.errors or formset.errors %}
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <h5 class="alert-heading"><i class="bi bi-exclamation-triangle-fill"></i> 表单填写不完整！</h5>
            <p class="mb-0">请检查下方标红的必填项，补充完整后再提交。</p>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endif %}
        
        <form method="post" enctype="multipart/form-data" id="reimbursement-form">
            {% csrf_token %}
            
            <!-- 基本信息 -->
            <div class="card mb-4 {% if form.errors %}border-danger{% endif %}">
                <div class="card-header {% if form.errors %}bg-danger text-white{% endif %}">
                    <i class="bi bi-info-circle"></i> 基本信息 
                    {% if form.errors %}<span class="badge bg-white text-danger">有未填项</span>{% endif %}
                </div>
                <div class="card-body">
                    <!-- 活动主题（下拉+输入联动） -->
                    <div class="mb-3">
                        <label class="form-label">活动主题 <span class="text-danger">*</span></label>
                        <div class="row g-2">
                            <div class="col-md-4">
                                {{ form.existing_theme }}
                                <small class="text-muted">选择已有主题会自动填充时间，若选择主题并在右栏键入则视为修改该主题名称</small>
                            </div>
                            <div class="col-md-8">
                                {{ form.theme }}
                                {% if form.theme.errors %}
                                <div class="text-danger small">{{ form.theme.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- 活动时间 -->
                    <div class="mb-3">
                        <label class="form-label">活动时间 <span class="text-danger">*</span></label>
                        <div class="row g-2">
                            <div class="col-4">
                                <label class="form-label small">年份</label>
                                {{ form.activity_year }}
                            </div>
                            <div class="col-4">
                                <label class="form-label small">月份</label>
                                {{ form.activity_month }}
                            </div>
                            <div class="col-4">
                                <label class="form-label small">日期</label>
                                {{ form.activity_day }}
                            </div>
                        </div>
                    </div>
                    
                    <!-- 活动地点 -->
                    <div class="mb-3">
                        <label class="form-label">活动地点 <span class="text-danger">*</span></label>
                        {{ form.activity_location }}
                    </div>
                    
                    <!-- 相关负责人 -->
                    <div class="mb-3">
                        <label class="form-label">相关负责人 <span class="text-danger">*</span></label>
                        {{ form.activity_leader }}
                    </div>
                    
                    <!-- 活动内容（选填） -->
                    <div class="mb-3">
                        <label class="form-label">活动主要内容 <span class="text-muted small">(选填)</span></label>
                        {{ form.description }}
                    </div>
                </div>
            </div>

            <!-- 物品明细（每个物品带发票上传） -->
            <div class="card mb-4 {% if formset.errors %}border-danger{% endif %}">
                <div class="card-header d-flex justify-content-between align-items-center {% if formset.errors %}bg-danger text-white{% endif %}">
                    <span>
                        <i class="bi bi-list-ul"></i> 物品明细 <span class="text-danger">*</span>
                        {% if formset.errors %}<span class="badge bg-white text-danger ms-2">有未填项</span>{% endif %}
                    </span>
                    <button type="button" class="btn btn-sm btn-success" id="add-item">
                        <i class="bi bi-plus"></i> 添加物品
                    </button>
                </div>
                <div class="card-body">
                    {{ formset.management_form }}
                    
                    <div id="items-container">
                        {% for item_form in formset %}
                        <div class="item-block card mb-3 {% if item_form.errors %}border-danger{% endif %}">
                            <div class="card-body">
                                {{ item_form.id }}
                                <div class="row g-2 align-items-end">
                                    <div class="col-md-4">
                                        <label class="form-label small">物品名称</label>
                                        {{ item_form.name }}
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small">数量</label>
                                        {{ item_form.quantity }}
                                    </div>
                                    <div class="col-md-1">
                                        <label class="form-label small">单位</label>
                                        {{ item_form.unit }}
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small">单价(元)</label>
                                        {{ item_form.price }}
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small">金额</label>
                                        <input type="text" class="form-control item-amount" readonly placeholder="自动计算">
                                    </div>
                                    <div class="col-md-1 text-end">
                                        {% if formset.can_delete %}
                                        <label class="form-label small">删除</label>
                                        <div>{{ item_form.DELETE }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- 此物品的发票上传 -->
                                <div class="mt-3 p-2 bg-light rounded">
                                    <label class="form-label small"><i class="bi bi-file-earmark-pdf"></i> 上传此物品的发票/凭证</label>
                                    <input type="file" name="item_{{ forloop.counter0 }}_files" class="form-control form-control-sm" multiple accept=".pdf,.jpg,.jpeg,.png,.gif,.bmp,.webp,image/*,application/pdf">
                                    <small class="text-muted">支持PDF、JPG、PNG格式，可多选</small>
                                    
                                    <!-- 已上传的发票列表 -->
                                    {% if item_form.instance.pk and item_form.instance.invoices.exists %}
                                    <div class="mt-2">
                                        <small class="text-muted">已上传：</small>
                                        {% for invoice in item_form.instance.invoices.all %}
                                        <span class="badge bg-secondary me-1">
                                            {{ invoice.file_name }}
                                            <a href="{{ invoice.file.url }}" target="_blank" class="text-white"><i class="bi bi-eye"></i></a>
                                        </span>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <p class="text-muted small"><i class="bi bi-info-circle"></i> 每个物品下方可以上传该物品对应的发票、订单截图等凭证</p>
                </div>
            </div>

            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <a href="{% url 'dashboard' %}" class="btn btn-secondary me-md-2">取消</a>
                <button type="submit" name="save_draft" class="btn btn-outline-info">暂存</button>
                <button type="submit" class="btn btn-primary btn-lg">{% if is_new %}提交报销申请{% else %}重新提交{% endif %}</button>
            </div>
        </form>
    </div>
</div>

<!-- 空物品模板（用于JavaScript添加新行） -->
<template id="empty-item-template">
    <div class="item-block card mb-3">
        <div class="card-body">
            <input type="hidden" name="items-__prefix__-id" id="id_items-__prefix__-id">
            <div class="row g-2 align-items-end">
                <div class="col-md-4">
                    <label class="form-label small">物品名称</label>
                    <input type="text" name="items-__prefix__-name" class="form-control item-name" placeholder="物品名称">
                </div>
                <div class="col-md-2">
                    <label class="form-label small">数量</label>
                    <input type="number" name="items-__prefix__-quantity" class="form-control item-quantity" min="1" value="1">
                </div>
                <div class="col-md-1">
                    <label class="form-label small">单位</label>
                    <input type="text" name="items-__prefix__-unit" class="form-control item-unit" value="个">
                </div>
                <div class="col-md-2">
                    <label class="form-label small">单价(元)</label>
                    <input type="number" name="items-__prefix__-price" class="form-control item-price" step="0.01" min="0.01">
                </div>
                <div class="col-md-2">
                    <label class="form-label small">金额</label>
                    <input type="text" class="form-control item-amount" readonly placeholder="自动计算">
                </div>
                <div class="col-md-1 text-end">
                    <label class="form-label small">删除</label>
                    <div><input type="checkbox" name="items-__prefix__-DELETE" class="form-check-input"></div>
                </div>
            </div>
            <div class="mt-3 p-2 bg-light rounded">
                <label class="form-label small"><i class="bi bi-file-earmark-pdf"></i> 上传此物品的发票/凭证</label>
                <input type="file" name="item___prefix___files" class="form-control form-control-sm" multiple accept=".pdf,.jpg,.jpeg,.png,.gif,.bmp,.webp,image/*,application/pdf">
                <small class="text-muted">支持PDF、JPG、PNG格式，可多选</small>
            </div>
        </div>
    </div>
</template>
{% endblock %}

{% block extra_js %}
<script>
// 活动主题数据
let themesData = [];

// 选择已有主题时自动填充的函数
function setupThemeAutoFill() {
    const themeSelect = document.getElementById('id_existing_theme');
    if (!themeSelect) {
        console.error('找不到 id_existing_theme 元素');
        return;
    }
    
    // 移除旧的事件监听器（如果存在）
    const newThemeSelect = themeSelect.cloneNode(true);
    themeSelect.parentNode.replaceChild(newThemeSelect, themeSelect);
    
    // 绑定新的事件监听器
    newThemeSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        console.log('选择主题:', selectedOption.textContent, '值:', selectedOption.value);
        console.log('年份:', selectedOption.dataset.year, '月份:', selectedOption.dataset.month, '日期:', selectedOption.dataset.day);
        
        if (selectedOption.value) {
            const year = parseInt(selectedOption.dataset.year);
            const month = parseInt(selectedOption.dataset.month);
            const day = parseInt(selectedOption.dataset.day);
            
            console.log('解析后的时间:', year, month, day);
            
            // 设置主题名称（确保值被正确设置）
            const themeInput = document.getElementById('id_theme');
            if (themeInput) {
                themeInput.value = selectedOption.textContent;
                // 触发input事件，确保表单验证能识别到值
                themeInput.dispatchEvent(new Event('input', { bubbles: true }));
            }
            
            // 获取时间选择字段
            const yearSelect = document.getElementById('id_activity_year');
            const monthSelect = document.getElementById('id_activity_month');
            const daySelect = document.getElementById('id_activity_day');
            
            if (!yearSelect || !monthSelect || !daySelect) {
                console.error('找不到时间选择字段');
                return;
            }
            
            if (year && month && day && !isNaN(year) && !isNaN(month) && !isNaN(day)) {
                console.log('开始填充时间:', year, month, day);
                
                // 1. 确保年份选项包含所选年份（如果不在当前可选范围内，动态添加）
                const yearExists = Array.from(yearSelect.options).some(opt => parseInt(opt.value) === year);
                if (!yearExists) {
                    const yearOption = document.createElement('option');
                    yearOption.value = year;
                    yearOption.textContent = year + '年';
                    yearSelect.appendChild(yearOption);
                    console.log('添加年份选项:', year);
                }
                
                // 2. 设置年份值
                yearSelect.value = year;
                console.log('设置年份:', yearSelect.value);
                
                // 3. 启用月份并重新生成月份选项（如果被禁用）
                if (monthSelect.disabled) {
                    monthSelect.disabled = false;
                    if (typeof initializeMonthOptions === 'function') {
                        initializeMonthOptions();
                    }
                }
                
                // 4. 设置月份值
                monthSelect.value = month;
                console.log('设置月份:', monthSelect.value);
                
                // 5. 更新日期选项并设置日期值
                if (typeof updateDayOptions === 'function') {
                    updateDayOptions(year, month);
                }
                
                // 6. 等待日期选项生成后，设置日期值
                setTimeout(function() {
                    daySelect.value = day;
                    daySelect.disabled = false;
                    console.log('设置日期:', daySelect.value);
                    
                    // 触发change事件，确保表单验证能识别到值
                    yearSelect.dispatchEvent(new Event('change', { bubbles: true }));
                    monthSelect.dispatchEvent(new Event('change', { bubbles: true }));
                    daySelect.dispatchEvent(new Event('change', { bubbles: true }));
                    
                    console.log('时间填充完成');
                }, 100);
            } else {
                console.error('时间数据无效:', year, month, day);
            }
        } else {
            // 清空选择时，也清空主题输入框
            const themeInput = document.getElementById('id_theme');
            if (themeInput) {
                themeInput.value = '';
            }
        }
    });
}

// 加载活动主题列表
fetch('{% url "get_activity_themes" %}')
    .then(response => {
        if (!response.ok) {
            throw new Error('网络请求失败');
        }
        return response.json();
    })
    .then(data => {
        themesData = data.themes || [];
        const select = document.getElementById('id_existing_theme');
        
        if (!select) {
            console.error('找不到 id_existing_theme 元素');
            return;
        }
        
        // 清空现有选项（除了第一个提示选项）
        select.innerHTML = '<option value="">-- 选择已有主题 --</option>';
        
        if (themesData.length === 0) {
            // 如果没有主题，显示提示
            const option = document.createElement('option');
            option.value = '';
            option.textContent = '暂无已有主题';
            option.disabled = true;
            select.appendChild(option);
        } else {
            // 添加主题选项
            themesData.forEach(theme => {
                const option = document.createElement('option');
                option.value = theme.id;
                option.textContent = theme.name;
                option.dataset.year = theme.year;
                option.dataset.month = theme.month;
                option.dataset.day = theme.day;
                select.appendChild(option);
                console.log('添加主题选项:', theme.name, '时间:', theme.year, theme.month, theme.day);
            });
        }
        
        // 选项加载完成后，绑定事件监听器
        setupThemeAutoFill();
    })
    .catch(error => {
        console.error('加载活动主题失败:', error);
        const select = document.getElementById('id_existing_theme');
        if (select) {
            const option = document.createElement('option');
            option.value = '';
            option.textContent = '加载失败，请刷新页面';
            option.disabled = true;
            select.appendChild(option);
        }
    });

// 判断是否为闰年
function isLeapYear(year) {
    return (year % 4 === 0 && year % 100 !== 0) || (year % 400 === 0);
}

// 获取指定年月的天数
function getDaysInMonth(year, month) {
    const daysInMonth = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
    if (month === 2 && isLeapYear(year)) {
        return 29;
    }
    return daysInMonth[month - 1];
}

// 更新日期下拉选项
function updateDayOptions(year, month) {
    console.log('updateDayOptions 被调用:', year, month);
    const daySelect = document.getElementById('id_activity_day');
    if (!daySelect) {
        console.error('日期选择元素未找到');
        return;
    }
    
    const currentDay = daySelect.value;
    
    if (!year || !month) {
        console.log('年份或月份为空，禁用日期选择框');
        daySelect.innerHTML = '<option value="">-- 请先选择年月 --</option>';
        daySelect.setAttribute('disabled', 'disabled');
        daySelect.disabled = true;
        return;
    }
    
    // 启用日期选择框（必须同时移除属性和设置disabled）
    daySelect.removeAttribute('disabled');
    daySelect.disabled = false;
    
    const yearNum = parseInt(year);
    const monthNum = parseInt(month);
    const daysInMonth = getDaysInMonth(yearNum, monthNum);
    
    console.log('生成日期选项:', yearNum, '年', monthNum, '月，共', daysInMonth, '天');
    
    // 保存当前选中的日期
    let selectedDay = currentDay;
    if (selectedDay && parseInt(selectedDay) > daysInMonth) {
        selectedDay = daysInMonth; // 如果当前日期超过该月最大天数，设为最大天数
    }
    
    // 清空并重新填充日期选项
    daySelect.innerHTML = '<option value="">-- 选择日期 --</option>';
    for (let day = 1; day <= daysInMonth; day++) {
        const option = document.createElement('option');
        option.value = day;
        option.textContent = day + '日';
        if (selectedDay && day === parseInt(selectedDay)) {
            option.selected = true;
        }
        daySelect.appendChild(option);
    }
    
    console.log('日期选项已生成，共', daysInMonth, '个选项');
}

// 初始化年份选项（根据当前月份动态设置）
function initializeYearOptions() {
    const now = new Date();
    const currentMonth = now.getMonth() + 1; // JavaScript月份从0开始
    const currentYear = now.getFullYear();
    
    const yearSelect = document.getElementById('id_activity_year');
    const currentYearValue = yearSelect.value;
    
    // 清空年份选项
    yearSelect.innerHTML = '<option value="">-- 选择年份 --</option>';
    
    // 如果当前是1-6月，可以选择去年和今年；如果是7-12月，只能选择今年
    if (currentMonth <= 6) {
        const option1 = document.createElement('option');
        option1.value = currentYear - 1;
        option1.textContent = (currentYear - 1) + '年';
        if (currentYearValue == currentYear - 1) option1.selected = true;
        yearSelect.appendChild(option1);
        
        const option2 = document.createElement('option');
        option2.value = currentYear;
        option2.textContent = currentYear + '年';
        if (currentYearValue == currentYear || !currentYearValue) option2.selected = true;
        yearSelect.appendChild(option2);
    } else {
        const option = document.createElement('option');
        option.value = currentYear;
        option.textContent = currentYear + '年';
        if (!currentYearValue) option.selected = true;
        yearSelect.appendChild(option);
    }
}

// 初始化月份选项（1-12月）
function initializeMonthOptions() {
    const monthSelect = document.getElementById('id_activity_month');
    const yearSelect = document.getElementById('id_activity_year');
    const currentMonthValue = monthSelect.value;
    
    if (!monthSelect || !yearSelect) {
        console.error('月份或年份选择元素未找到');
        return;
    }
    
    // 强制重新生成月份选项，确保级联逻辑正确
    monthSelect.innerHTML = '<option value="">-- 请先选择年份 --</option>';
    for (let month = 1; month <= 12; month++) {
        const option = document.createElement('option');
        option.value = month;
        option.textContent = month + '月';
        if (currentMonthValue == month) option.selected = true;
        monthSelect.appendChild(option);
    }
    
    // 如果年份没有值，禁用月份
    if (!yearSelect.value) {
        monthSelect.setAttribute('disabled', 'disabled');
        monthSelect.disabled = true;
    } else {
        // 如果年份有值，确保月份可用
        monthSelect.removeAttribute('disabled');
        monthSelect.disabled = false;
    }
}

// 启用/禁用月份选择
function setMonthEnabled(enabled) {
    const monthSelect = document.getElementById('id_activity_month');
    if (!monthSelect) return;
    
    if (enabled) {
        monthSelect.removeAttribute('disabled');
        monthSelect.disabled = false;
        // 重新生成月份选项
        const currentMonthValue = monthSelect.value;
        monthSelect.innerHTML = '<option value="">-- 选择月份 --</option>';
        for (let month = 1; month <= 12; month++) {
            const option = document.createElement('option');
            option.value = month;
            option.textContent = month + '月';
            if (currentMonthValue == month) option.selected = true;
            monthSelect.appendChild(option);
        }
    } else {
        monthSelect.setAttribute('disabled', 'disabled');
        monthSelect.disabled = true;
        monthSelect.innerHTML = '<option value="">-- 请先选择年份 --</option>';
        monthSelect.value = '';
    }
}

// 启用/禁用日期选择
function setDayEnabled(enabled) {
    const daySelect = document.getElementById('id_activity_day');
    if (!daySelect) return;
    
    if (enabled) {
        daySelect.removeAttribute('disabled');
        daySelect.disabled = false;
    } else {
        daySelect.setAttribute('disabled', 'disabled');
        daySelect.disabled = true;
        daySelect.innerHTML = '<option value="">-- 请先选择年月 --</option>';
        daySelect.value = '';
    }
}

// 级联选择初始化函数（年份 → 月份 → 日期）
function initCascadeSelect() {
    const yearSelect = document.getElementById('id_activity_year');
    const monthSelect = document.getElementById('id_activity_month');
    const daySelect = document.getElementById('id_activity_day');
    
    if (!yearSelect || !monthSelect || !daySelect) {
        console.error('日期选择元素未找到');
        return;
    }
    
    // 初始化年份和月份选项
    initializeYearOptions();
    initializeMonthOptions();
    
    // 设置初始状态
    function updateCascadeState() {
        if (yearSelect.value) {
            // 有年份，启用月份（必须同时移除属性和设置disabled）
            monthSelect.removeAttribute('disabled');
            monthSelect.disabled = false;
            if (monthSelect.value) {
                // 有月份，启用日期并更新
                daySelect.removeAttribute('disabled');
                daySelect.disabled = false;
                updateDayOptions(yearSelect.value, monthSelect.value);
            } else {
                // 没有月份，禁用日期
                daySelect.setAttribute('disabled', 'disabled');
                daySelect.disabled = true;
                daySelect.innerHTML = '<option value="">-- 请先选择月份 --</option>';
            }
        } else {
            // 没有年份，禁用月份和日期
            monthSelect.setAttribute('disabled', 'disabled');
            monthSelect.disabled = true;
            monthSelect.innerHTML = '<option value="">-- 请先选择年份 --</option>';
            daySelect.setAttribute('disabled', 'disabled');
            daySelect.disabled = true;
            daySelect.innerHTML = '<option value="">-- 请先选择年月 --</option>';
        }
    }
    
    // 初始状态 - 如果已有值，保留它们
    const savedYear = yearSelect.value;
    const savedMonth = monthSelect.value;
    const savedDay = daySelect.value;
    
    updateCascadeState();
    
    // 如果之前有值，恢复它们
    if (savedYear) {
        yearSelect.value = savedYear;
        if (savedMonth) {
            // 重新生成月份选项并设置值
            monthSelect.innerHTML = '<option value="">-- 选择月份 --</option>';
            for (let month = 1; month <= 12; month++) {
                const option = document.createElement('option');
                option.value = month;
                option.textContent = month + '月';
                if (savedMonth == month) option.selected = true;
                monthSelect.appendChild(option);
            }
            monthSelect.removeAttribute('disabled');
            monthSelect.disabled = false;
            monthSelect.value = savedMonth;
            
            // 无论是否有日期值，都要生成日期选项（因为已有年月值）
            updateDayOptions(savedYear, savedMonth);
            if (savedDay) {
                // 如果有日期值，设置它
                setTimeout(function() {
                    daySelect.value = savedDay;
                }, 10);
            }
        }
    }
    
    // 监听年份变化
    yearSelect.addEventListener('change', function() {
        console.log('年份选择变化:', this.value);
        if (this.value) {
            // 选择了年份，启用月份（必须同时移除属性和设置disabled）
            monthSelect.removeAttribute('disabled');
            monthSelect.disabled = false;
            // 重新生成月份选项
            const currentMonth = monthSelect.value;
            monthSelect.innerHTML = '<option value="">-- 选择月份 --</option>';
            for (let month = 1; month <= 12; month++) {
                const option = document.createElement('option');
                option.value = month;
                option.textContent = month + '月';
                if (currentMonth == month) option.selected = true;
                monthSelect.appendChild(option);
            }
            console.log('月份选项已生成，月份选择框可用:', !monthSelect.disabled);
            // 如果月份有值，更新日期
            if (monthSelect.value) {
                daySelect.removeAttribute('disabled');
                daySelect.disabled = false;
                updateDayOptions(this.value, monthSelect.value);
            } else {
                // 没有月份，禁用日期
                daySelect.setAttribute('disabled', 'disabled');
                daySelect.disabled = true;
                daySelect.innerHTML = '<option value="">-- 请先选择月份 --</option>';
                daySelect.value = '';
            }
        } else {
            // 清空年份
            monthSelect.setAttribute('disabled', 'disabled');
            monthSelect.disabled = true;
            monthSelect.innerHTML = '<option value="">-- 请先选择年份 --</option>';
            monthSelect.value = '';
            daySelect.setAttribute('disabled', 'disabled');
            daySelect.disabled = true;
            daySelect.innerHTML = '<option value="">-- 请先选择年月 --</option>';
            daySelect.value = '';
        }
    });
    
    // 监听月份变化
    monthSelect.addEventListener('change', function() {
        console.log('月份选择变化:', this.value, '年份:', yearSelect.value);
        if (this.value && yearSelect.value) {
            // 选择了月份且年份也有值，启用日期并更新（必须同时移除属性和设置disabled）
            daySelect.removeAttribute('disabled');
            daySelect.disabled = false;
            updateDayOptions(yearSelect.value, this.value);
            console.log('日期选项已更新，日期选择框可用:', !daySelect.disabled);
        } else {
            // 清空月份或年份没有值，禁用日期
            daySelect.setAttribute('disabled', 'disabled');
            daySelect.disabled = true;
            daySelect.innerHTML = '<option value="">-- 请先选择年月 --</option>';
            daySelect.value = '';
        }
    });
}

// 页面加载完成后初始化
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCascadeSelect);
} else {
    // DOM已经加载完成，立即执行
    initCascadeSelect();
}

// 添加物品行
document.getElementById('add-item').addEventListener('click', function() {
    const container = document.getElementById('items-container');
    const formIdx = document.getElementById('id_items-TOTAL_FORMS').value;
    const template = document.getElementById('empty-item-template');
    const newItem = template.content.cloneNode(true);

    // 替换__prefix__为实际索引
    const html = newItem.querySelector('.item-block').outerHTML.replace(/__prefix__/g, formIdx);
    container.insertAdjacentHTML('beforeend', html);

    document.getElementById('id_items-TOTAL_FORMS').value = parseInt(formIdx) + 1;

    // 确保新添加的字段可以输入
    setTimeout(function() {
        // 等待DOM更新后再绑定事件
        const newRow = container.lastElementChild;
        if (newRow) {
            // 确保数量和单价字段没有被禁用
            const quantityField = newRow.querySelector('.item-quantity');
            const priceField = newRow.querySelector('.item-price');

            if (quantityField) {
                quantityField.disabled = false;
                quantityField.style.pointerEvents = 'auto';
            }
            if (priceField) {
                priceField.disabled = false;
                priceField.style.pointerEvents = 'auto';
            }
        }

        // 绑定金额计算
        bindAmountCalculation();
    }, 10);
});

// 绑定金额自动计算
function bindAmountCalculation() {
    // 简单的金额计算绑定
    document.querySelectorAll('.item-quantity, .item-price').forEach(input => {
        // 确保字段没有被禁用
        input.disabled = false;
        input.style.pointerEvents = 'auto';
        input.style.backgroundColor = 'white';

        // 直接添加输入事件监听器（如果还没有添加过）
        if (!input.hasAttribute('data-bound')) {
            input.setAttribute('data-bound', 'true');
            input.addEventListener('input', function() {
                const row = this.closest('.row');
                const qty = parseFloat(row.querySelector('.item-quantity').value) || 0;
                const price = parseFloat(row.querySelector('.item-price').value) || 0;
                const amountField = row.querySelector('.item-amount');
                if (amountField) {
                    amountField.value = (qty * price).toFixed(2);
                }
            });
        }
    });
}

// 初始化 - 确保所有物品字段都可以输入
function initializeItemFields() {
    // 确保现有的物品字段可以输入
    document.querySelectorAll('.item-quantity, .item-price').forEach(field => {
        field.disabled = false;
        field.style.pointerEvents = 'auto';
    });

    // 绑定金额计算
    bindAmountCalculation();
}

initializeItemFields();

// 表单验证
// 表单提交前，移除disabled属性，确保值能正确提交
document.getElementById('reimbursement-form').addEventListener('submit', function(e) {
    // 移除所有disabled属性，确保值能提交
    const monthSelect = document.getElementById('id_activity_month');
    const daySelect = document.getElementById('id_activity_day');
    if (monthSelect) monthSelect.removeAttribute('disabled');
    if (daySelect) daySelect.removeAttribute('disabled');
    if (e.submitter && e.submitter.name === 'save_draft') return true;
    
    let hasError = false;
    let errorMessages = [];
    
    function validateField(selector, fieldName) {
        const field = document.querySelector(selector);
        if (field) {
            const value = field.value ? field.value.trim() : '';
            if (!value) {
                field.style.border = '2px solid red';
                errorMessages.push(fieldName);
                return false;
            } else {
                field.style.border = '';
            }
        }
        return true;
    }
    
    if (!validateField('#id_theme', '活动主题')) hasError = true;
    if (!validateField('#id_activity_year', '活动年份')) hasError = true;
    if (!validateField('#id_activity_month', '活动月份')) hasError = true;
    if (!validateField('#id_activity_day', '活动日期')) hasError = true;
    if (!validateField('[name="activity_location"]', '活动地点')) hasError = true;
    if (!validateField('[name="activity_leader"]', '相关负责人')) hasError = true;
    
    // 检查至少有一个物品
    const itemBlocks = document.querySelectorAll('.item-block');
    let hasValidItem = false;
    itemBlocks.forEach(block => {
        const deleteCheck = block.querySelector('[name$="-DELETE"]');
        if (deleteCheck && deleteCheck.checked) return;
        const name = block.querySelector('.item-name');
        if (name && name.value.trim()) hasValidItem = true;
    });
    
    if (!hasValidItem) {
        errorMessages.push('至少一个物品');
        hasError = true;
    }
    
    if (hasError) {
        e.preventDefault();
        alert('请填写以下必填项：\n' + errorMessages.join('\n'));
        
        // 验证失败后，重新初始化级联选择以保留已有值
        setTimeout(function() {
            initCascadeSelect();
        }, 100);
        
        return false;
    }
    return true;
});
</script>
{% endblock %}

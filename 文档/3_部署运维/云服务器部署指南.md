# äº‘æœåŠ¡å™¨å®Œæ•´éƒ¨ç½²æŒ‡å—

## ğŸš€ å®Œæ•´éƒ¨ç½²æ–¹æ¡ˆï¼ˆå…¬ç½‘è®¿é—®ï¼‰

æœ¬æŒ‡å—å°†å¸®åŠ©æ‚¨å°†æŠ¥é”€ç¥è¡¨éƒ¨ç½²åˆ°äº‘æœåŠ¡å™¨ï¼Œè®©ä»»ä½•äººéƒ½å¯ä»¥é€šè¿‡äº’è”ç½‘è®¿é—®ã€‚

---

## ğŸ“‹ éƒ¨ç½²å‰å‡†å¤‡

### 1. äº‘æœåŠ¡å™¨è¦æ±‚
- **é…ç½®**ï¼š2æ ¸CPUã€4GBå†…å­˜ã€90GBç¡¬ç›˜ï¼ˆæ‚¨å·²å…·å¤‡ï¼‰
- **ç³»ç»Ÿ**ï¼šæ¨è Ubuntu 20.04/22.04 æˆ– CentOS 7/8
- **ç½‘ç»œ**ï¼šå…¬ç½‘IPåœ°å€
- **ç«¯å£**ï¼šç¡®ä¿å¼€æ”¾ 80ã€443ã€8000 ç«¯å£

### 2. æœ¬åœ°å‡†å¤‡
- é¡¹ç›®æ–‡ä»¶å·²å‡†å¤‡å¥½
- å·²æµ‹è¯•æœ¬åœ°è¿è¡Œæ­£å¸¸

---

## ğŸ”§ ç¬¬ä¸€æ­¥ï¼šè¿æ¥æœåŠ¡å™¨

### Windowsç³»ç»Ÿï¼ˆä½¿ç”¨PuTTYæˆ–Windows Terminalï¼‰

```bash
ssh root@æ‚¨çš„æœåŠ¡å™¨IP
```

æˆ–ä½¿ç”¨å¯†ç ç™»å½•ï¼š
```bash
ssh ç”¨æˆ·å@æ‚¨çš„æœåŠ¡å™¨IP
```

### é¦–æ¬¡è¿æ¥ä¼šæç¤ºç¡®è®¤ï¼Œè¾“å…¥ `yes`

---

## ğŸ“¦ ç¬¬äºŒæ­¥ï¼šæœåŠ¡å™¨ç¯å¢ƒé…ç½®

### 1. æ›´æ–°ç³»ç»Ÿ
```bash
# Ubuntu/Debian
sudo apt update && sudo apt upgrade -y

# CentOS
sudo yum update -y
```

### 2. å®‰è£…Pythonå’Œpip
```bash
# Ubuntu/Debian
sudo apt install python3 python3-pip python3-venv -y

# CentOS
sudo yum install python3 python3-pip -y
```

### 3. å®‰è£…Nginxï¼ˆWebæœåŠ¡å™¨ï¼‰
```bash
# Ubuntu/Debian
sudo apt install nginx -y

# CentOS
sudo yum install nginx -y
```

### 4. å®‰è£…æ•°æ®åº“ï¼ˆå¯é€‰ï¼Œç”Ÿäº§ç¯å¢ƒæ¨èï¼‰
```bash
# å®‰è£…PostgreSQLï¼ˆæ¨èï¼‰
sudo apt install postgresql postgresql-contrib -y  # Ubuntu
# æˆ–
sudo yum install postgresql-server postgresql-contrib -y  # CentOS

# æˆ–è€…å®‰è£…MySQL
sudo apt install mysql-server -y  # Ubuntu
```

---

## ğŸ“ ç¬¬ä¸‰æ­¥ï¼šä¸Šä¼ é¡¹ç›®æ–‡ä»¶

### æ–¹æ³•1ï¼šä½¿ç”¨Gitï¼ˆæ¨èï¼‰

åœ¨æœåŠ¡å™¨ä¸Šï¼š
```bash
# å®‰è£…Git
sudo apt install git -y  # Ubuntu
# æˆ–
sudo yum install git -y  # CentOS

# å…‹éš†é¡¹ç›®ï¼ˆå¦‚æœå·²ä¸Šä¼ åˆ°Gitä»“åº“ï¼‰
git clone æ‚¨çš„ä»“åº“åœ°å€
cd é¡¹ç›®æ–‡ä»¶å¤¹å
```

### æ–¹æ³•2ï¼šä½¿ç”¨SCPï¼ˆä»æœ¬åœ°Windowsä¸Šä¼ ï¼‰

åœ¨**æœ¬åœ°Windows PowerShell**ä¸­ï¼š
```powershell
# å®‰è£…WinSCPæˆ–ä½¿ç”¨å†…ç½®scp
scp -r "C:\Users\46789\Desktop\å¤§å››ç¬¬ä¸€å­¦æœŸ\è½¯ä»¶å·¥ç¨‹\å¤§ä½œä¸š\æŠ¥é”€ç¥è¡¨" root@æ‚¨çš„æœåŠ¡å™¨IP:/opt/

# æˆ–ä½¿ç”¨WinSCPå›¾å½¢å·¥å…·ï¼ˆæ›´ç®€å•ï¼‰
```

### æ–¹æ³•3ï¼šä½¿ç”¨FTPå·¥å…·
- ä¸‹è½½ FileZilla æˆ– WinSCP
- è¿æ¥åˆ°æœåŠ¡å™¨
- ä¸Šä¼ æ•´ä¸ªé¡¹ç›®æ–‡ä»¶å¤¹åˆ° `/opt/reimbursement_system/`

---

## ğŸ ç¬¬å››æ­¥ï¼šé…ç½®Pythonç¯å¢ƒ

åœ¨æœåŠ¡å™¨ä¸Šï¼š

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd /opt/reimbursement_system  # æˆ–æ‚¨çš„é¡¹ç›®è·¯å¾„

# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python3 -m venv venv

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
source venv/bin/activate

# å®‰è£…ä¾èµ–
pip install -r requirements.txt

# å¦‚æœé€Ÿåº¦æ…¢ï¼Œä½¿ç”¨å›½å†…é•œåƒ
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
```

---

## ğŸ—„ï¸ ç¬¬äº”æ­¥ï¼šé…ç½®æ•°æ®åº“

### é€‰é¡¹Aï¼šç»§ç»­ä½¿ç”¨SQLiteï¼ˆç®€å•ï¼Œé€‚åˆå°è§„æ¨¡ä½¿ç”¨ï¼‰

æ— éœ€é¢å¤–é…ç½®ï¼Œç›´æ¥ä½¿ç”¨ã€‚

### é€‰é¡¹Bï¼šä½¿ç”¨PostgreSQLï¼ˆæ¨èç”Ÿäº§ç¯å¢ƒï¼‰

```bash
# åˆ›å»ºæ•°æ®åº“å’Œç”¨æˆ·
sudo -u postgres psql

# åœ¨PostgreSQLå‘½ä»¤è¡Œä¸­æ‰§è¡Œï¼š
CREATE DATABASE reimbursement_db;
CREATE USER reimbursement_user WITH PASSWORD 'æ‚¨çš„å¯†ç ';
ALTER ROLE reimbursement_user SET client_encoding TO 'utf8';
ALTER ROLE reimbursement_user SET default_transaction_isolation TO 'read committed';
ALTER ROLE reimbursement_user SET timezone TO 'Asia/Shanghai';
GRANT ALL PRIVILEGES ON DATABASE reimbursement_db TO reimbursement_user;
\q
```

ä¿®æ”¹ `reimbursement_system/settings.py`ï¼š
```python
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': 'reimbursement_db',
        'USER': 'reimbursement_user',
        'PASSWORD': 'æ‚¨çš„å¯†ç ',
        'HOST': 'localhost',
        'PORT': '5432',
    }
}
```

---

## âš™ï¸ ç¬¬å…­æ­¥ï¼šé…ç½®Djangoè®¾ç½®

ç¼–è¾‘ `reimbursement_system/settings.py`ï¼š

```python
# ä¿®æ”¹è¿™äº›è®¾ç½®
DEBUG = False  # ç”Ÿäº§ç¯å¢ƒå…³é—­è°ƒè¯•
ALLOWED_HOSTS = ['æ‚¨çš„åŸŸå.com', 'æ‚¨çš„æœåŠ¡å™¨IP', 'www.æ‚¨çš„åŸŸå.com']

# å¦‚æœä½¿ç”¨SQLiteï¼Œç¡®ä¿è·¯å¾„æ­£ç¡®
# å¦‚æœä½¿ç”¨PostgreSQLï¼Œå·²åœ¨ä¸Šä¸€æ­¥é…ç½®

# é™æ€æ–‡ä»¶æ”¶é›†
STATIC_ROOT = BASE_DIR / 'staticfiles'
```

æ”¶é›†é™æ€æ–‡ä»¶ï¼š
```bash
python manage.py collectstatic --noinput
```

---

## ğŸ—„ï¸ ç¬¬ä¸ƒæ­¥ï¼šåˆå§‹åŒ–æ•°æ®åº“

```bash
# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒï¼ˆå¦‚æœè¿˜æ²¡æ¿€æ´»ï¼‰
source venv/bin/activate

# è¿è¡Œè¿ç§»
python manage.py migrate

# åˆ›å»ºç®¡ç†å‘˜ï¼ˆæˆ–ä½¿ç”¨ä¹‹å‰çš„create_admin.pyï¼‰
python create_admin.py
```

---

## ğŸš€ ç¬¬å…«æ­¥ï¼šä½¿ç”¨Gunicornå¯åŠ¨

### æµ‹è¯•Gunicorn

```bash
# åœ¨é¡¹ç›®ç›®å½•ä¸‹
source venv/bin/activate
gunicorn reimbursement_system.wsgi:application --bind 0.0.0.0:8000
```

è®¿é—® `http://æ‚¨çš„æœåŠ¡å™¨IP:8000` æµ‹è¯•æ˜¯å¦æ­£å¸¸ã€‚

### åˆ›å»ºGunicornæœåŠ¡æ–‡ä»¶

åˆ›å»º `/etc/systemd/system/reimbursement.service`ï¼š

```bash
sudo nano /etc/systemd/system/reimbursement.service
```

æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š
```ini
[Unit]
Description=Reimbursement System Gunicorn
After=network.target

[Service]
User=www-data  # æˆ–æ‚¨çš„ç”¨æˆ·å
Group=www-data
WorkingDirectory=/opt/reimbursement_system  # æ‚¨çš„é¡¹ç›®è·¯å¾„
Environment="PATH=/opt/reimbursement_system/venv/bin"
ExecStart=/opt/reimbursement_system/venv/bin/gunicorn \
    --workers 3 \
    --bind unix:/opt/reimbursement_system/reimbursement.sock \
    reimbursement_system.wsgi:application

[Install]
WantedBy=multi-user.target
```

å¯åŠ¨æœåŠ¡ï¼š
```bash
sudo systemctl daemon-reload
sudo systemctl start reimbursement
sudo systemctl enable reimbursement  # å¼€æœºè‡ªå¯
sudo systemctl status reimbursement  # æŸ¥çœ‹çŠ¶æ€
```

---

## ğŸŒ ç¬¬ä¹æ­¥ï¼šé…ç½®Nginxåå‘ä»£ç†

åˆ›å»ºNginxé…ç½®æ–‡ä»¶ï¼š

```bash
sudo nano /etc/nginx/sites-available/reimbursement
```

æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š
```nginx
server {
    listen 80;
    server_name æ‚¨çš„åŸŸå.com æ‚¨çš„æœåŠ¡å™¨IP;  # æ²¡æœ‰åŸŸåå°±åªç”¨IP

    # é™æ€æ–‡ä»¶
    location /static/ {
        alias /opt/reimbursement_system/staticfiles/;
    }

    # åª’ä½“æ–‡ä»¶
    location /media/ {
        alias /opt/reimbursement_system/media/;
    }

    # Djangoåº”ç”¨
    location / {
        proxy_pass http://unix:/opt/reimbursement_system/reimbursement.sock;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

å¯ç”¨é…ç½®ï¼š
```bash
sudo ln -s /etc/nginx/sites-available/reimbursement /etc/nginx/sites-enabled/
sudo nginx -t  # æµ‹è¯•é…ç½®
sudo systemctl restart nginx
```

---

## ğŸ”’ ç¬¬åæ­¥ï¼šé…ç½®é˜²ç«å¢™

### Ubuntu (UFW)
```bash
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw allow 22/tcp  # SSH
sudo ufw enable
```

### CentOS (firewalld)
```bash
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --permanent --add-service=ssh
sudo firewall-cmd --reload
```

### äº‘æœåŠ¡å™¨æ§åˆ¶å°
åœ¨æ‚¨çš„äº‘æœåŠ¡å™¨æ§åˆ¶å°ï¼ˆé˜¿é‡Œäº‘/è…¾è®¯äº‘/åä¸ºäº‘ç­‰ï¼‰ï¼š
1. è¿›å…¥"å®‰å…¨ç»„"è®¾ç½®
2. æ·»åŠ å…¥ç«™è§„åˆ™ï¼š
   - ç«¯å£ï¼š80ï¼Œåè®®ï¼šTCPï¼Œæºï¼š0.0.0.0/0
   - ç«¯å£ï¼š443ï¼Œåè®®ï¼šTCPï¼Œæºï¼š0.0.0.0/0
   - ç«¯å£ï¼š22ï¼Œåè®®ï¼šTCPï¼Œæºï¼š0.0.0.0/0ï¼ˆSSHï¼‰

---

## âœ… ç¬¬åä¸€æ­¥ï¼šæµ‹è¯•è®¿é—®

1. åœ¨æµè§ˆå™¨è®¿é—®ï¼š`http://æ‚¨çš„æœåŠ¡å™¨IP`
2. åº”è¯¥èƒ½çœ‹åˆ°ç™»å½•é¡µé¢
3. ä½¿ç”¨ç®¡ç†å‘˜è´¦æˆ·ç™»å½•æµ‹è¯•

---

## ğŸ” ç¬¬åäºŒæ­¥ï¼šé…ç½®HTTPSï¼ˆå¯é€‰ä½†æ¨èï¼‰

### ä½¿ç”¨Let's Encryptå…è´¹SSLè¯ä¹¦

```bash
# å®‰è£…Certbot
sudo apt install certbot python3-certbot-nginx -y  # Ubuntu
# æˆ–
sudo yum install certbot python3-certbot-nginx -y  # CentOS

# è·å–è¯ä¹¦ï¼ˆéœ€è¦æœ‰åŸŸåï¼‰
sudo certbot --nginx -d æ‚¨çš„åŸŸå.com

# è‡ªåŠ¨ç»­æœŸ
sudo certbot renew --dry-run
```

---

## ğŸ“ å¿«é€Ÿéƒ¨ç½²è„šæœ¬

æˆ‘å·²ç»ä¸ºæ‚¨åˆ›å»ºäº†è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬ï¼Œè§ä¸‹æ–¹ã€‚

---

## ğŸ› ï¸ å¸¸ç”¨ç®¡ç†å‘½ä»¤

```bash
# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
sudo systemctl status reimbursement

# é‡å¯æœåŠ¡
sudo systemctl restart reimbursement

# æŸ¥çœ‹æ—¥å¿—
sudo journalctl -u reimbursement -f

# æŸ¥çœ‹Nginxæ—¥å¿—
sudo tail -f /var/log/nginx/error.log
```

---

## âš ï¸ é‡è¦æç¤º

1. **å®‰å…¨æ€§**ï¼š
   - ç”Ÿäº§ç¯å¢ƒå¿…é¡»è®¾ç½® `DEBUG = False`
   - ä½¿ç”¨å¼ºå¯†ç 
   - å®šæœŸæ›´æ–°ç³»ç»Ÿ

2. **å¤‡ä»½**ï¼š
   ```bash
   # å¤‡ä»½æ•°æ®åº“
   python manage.py dumpdata > backup.json
   
   # å¤‡ä»½æ–‡ä»¶
   tar -czf backup.tar.gz media/ db.sqlite3
   ```

3. **æ€§èƒ½ä¼˜åŒ–**ï¼š
   - ä½¿ç”¨PostgreSQLæ›¿ä»£SQLiteï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
   - é…ç½®Redisç¼“å­˜ï¼ˆå¯é€‰ï¼‰
   - ä½¿ç”¨CDNåŠ é€Ÿé™æ€æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰

---

## ğŸ†˜ æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼š502 Bad Gateway
- æ£€æŸ¥GunicornæœåŠ¡æ˜¯å¦è¿è¡Œï¼š`sudo systemctl status reimbursement`
- æ£€æŸ¥socketæ–‡ä»¶æƒé™

### é—®é¢˜2ï¼šé™æ€æ–‡ä»¶404
- è¿è¡Œ `python manage.py collectstatic`
- æ£€æŸ¥Nginxé…ç½®ä¸­çš„è·¯å¾„

### é—®é¢˜3ï¼šæ•°æ®åº“è¿æ¥å¤±è´¥
- æ£€æŸ¥æ•°æ®åº“æœåŠ¡æ˜¯å¦è¿è¡Œ
- æ£€æŸ¥settings.pyä¸­çš„æ•°æ®åº“é…ç½®

---

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. æœåŠ¡æ—¥å¿—ï¼š`sudo journalctl -u reimbursement -n 50`
2. Nginxæ—¥å¿—ï¼š`sudo tail -f /var/log/nginx/error.log`
3. Djangoæ—¥å¿—ï¼šæŸ¥çœ‹é¡¹ç›®ç›®å½•ä¸‹çš„æ—¥å¿—æ–‡ä»¶





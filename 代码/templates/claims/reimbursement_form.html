{% extends 'base.html' %}

{% block title %}{% if is_new %}新建报销单{% else %}编辑报销单{% endif %} - 报销神表{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h2>{% if is_new %}填写报销单{% else %}编辑报销单{% endif %}</h2>
        {% if not is_new and reimbursement.status == 'REJECTED' %}
        <div class="alert alert-warning">
            <strong>此报销单已被驳回</strong>。请根据审核意见修改后重新提交。
            {% if reimbursement.reviewer_note %}
            <br><strong>审核意见：</strong>{{ reimbursement.reviewer_note }}
            {% endif %}
        </div>
        {% endif %}
        <hr>
        
        {% if form.errors or formset.errors %}
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <h5 class="alert-heading"><i class="bi bi-exclamation-triangle-fill"></i> 表单填写不完整！</h5>
            <p class="mb-0">请检查下方标红的必填项，补充完整后再提交。</p>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endif %}
        
        <form method="post" enctype="multipart/form-data" id="reimbursement-form">
            {% csrf_token %}
            
            <!-- 基本信息 -->
            <div class="card mb-4 {% if form.errors %}border-danger{% endif %}">
                <div class="card-header {% if form.errors %}bg-danger text-white{% endif %}">
                    <i class="bi bi-info-circle"></i> 基本信息 
                    {% if form.errors %}<span class="badge bg-white text-danger">有未填项</span>{% endif %}
                </div>
                <div class="card-body">
                    <!-- 活动主题（下拉+输入联动） -->
                    <div class="mb-3">
                        <label class="form-label">活动主题 <span class="text-danger">*</span></label>
                        <div class="row g-2">
                            <div class="col-md-4">
                                <select id="existing-theme-select" class="form-select">
                                    <option value="">-- 选择已有主题 --</option>
                                </select>
                                <small class="text-muted">选择已有主题会自动填充时间</small>
                            </div>
                            <div class="col-md-8">
                                {{ form.theme }}
                                {% if form.theme.errors %}
                                <div class="text-danger small">{{ form.theme.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- 活动时间 -->
                    <div class="mb-3">
                        <label class="form-label">活动时间 <span class="text-danger">*</span></label>
                        <div class="row g-2">
                            <div class="col-4">
                                <label class="form-label small">年份</label>
                                {{ form.activity_year }}
                            </div>
                            <div class="col-4">
                                <label class="form-label small">月份</label>
                                {{ form.activity_month }}
                            </div>
                            <div class="col-4">
                                <label class="form-label small">日期</label>
                                {{ form.activity_day }}
                            </div>
                        </div>
                    </div>
                    
                    <!-- 活动地点 -->
                    <div class="mb-3">
                        <label class="form-label">活动地点 <span class="text-danger">*</span></label>
                        {{ form.activity_location }}
                    </div>
                    
                    <!-- 相关负责人 -->
                    <div class="mb-3">
                        <label class="form-label">相关负责人 <span class="text-danger">*</span></label>
                        {{ form.activity_leader }}
                    </div>
                    
                    <!-- 活动内容（选填） -->
                    <div class="mb-3">
                        <label class="form-label">活动主要内容 <span class="text-muted small">(选填)</span></label>
                        {{ form.description }}
                    </div>
                </div>
            </div>

            <!-- 物品明细（每个物品带发票上传） -->
            <div class="card mb-4 {% if formset.errors %}border-danger{% endif %}">
                <div class="card-header d-flex justify-content-between align-items-center {% if formset.errors %}bg-danger text-white{% endif %}">
                    <span>
                        <i class="bi bi-list-ul"></i> 物品明细 <span class="text-danger">*</span>
                        {% if formset.errors %}<span class="badge bg-white text-danger ms-2">有未填项</span>{% endif %}
                    </span>
                    <button type="button" class="btn btn-sm btn-success" id="add-item">
                        <i class="bi bi-plus"></i> 添加物品
                    </button>
                </div>
                <div class="card-body">
                    {{ formset.management_form }}
                    
                    <div id="items-container">
                        {% for item_form in formset %}
                        <div class="item-block card mb-3 {% if item_form.errors %}border-danger{% endif %}">
                            <div class="card-body">
                                {{ item_form.id }}
                                <div class="row g-2 align-items-end">
                                    <div class="col-md-4">
                                        <label class="form-label small">物品名称</label>
                                        {{ item_form.name }}
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small">数量</label>
                                        {{ item_form.quantity }}
                                    </div>
                                    <div class="col-md-1">
                                        <label class="form-label small">单位</label>
                                        {{ item_form.unit }}
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small">单价(元)</label>
                                        {{ item_form.price }}
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small">金额</label>
                                        <input type="text" class="form-control item-amount" readonly placeholder="自动计算">
                                    </div>
                                    <div class="col-md-1 text-end">
                                        {% if formset.can_delete %}
                                        <label class="form-label small">删除</label>
                                        <div>{{ item_form.DELETE }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- 此物品的发票上传 -->
                                <div class="mt-3 p-2 bg-light rounded">
                                    <label class="form-label small"><i class="bi bi-file-earmark-pdf"></i> 上传此物品的发票/凭证</label>
                                    <input type="file" name="item_{{ forloop.counter0 }}_files" class="form-control form-control-sm" multiple accept=".pdf,.jpg,.jpeg,.png">
                                    <small class="text-muted">支持PDF、JPG、PNG格式，可多选</small>
                                    
                                    <!-- 已上传的发票列表 -->
                                    {% if item_form.instance.pk and item_form.instance.invoices.exists %}
                                    <div class="mt-2">
                                        <small class="text-muted">已上传：</small>
                                        {% for invoice in item_form.instance.invoices.all %}
                                        <span class="badge bg-secondary me-1">
                                            {{ invoice.file_name }}
                                            <a href="{{ invoice.file.url }}" target="_blank" class="text-white"><i class="bi bi-eye"></i></a>
                                        </span>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <p class="text-muted small"><i class="bi bi-info-circle"></i> 每个物品下方可以上传该物品对应的发票、订单截图等凭证</p>
                </div>
            </div>

            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <a href="{% url 'dashboard' %}" class="btn btn-secondary me-md-2">取消</a>
                <button type="submit" name="save_draft" class="btn btn-outline-info">暂存</button>
                <button type="submit" class="btn btn-primary btn-lg">{% if is_new %}提交报销申请{% else %}重新提交{% endif %}</button>
            </div>
        </form>
    </div>
</div>

<!-- 空物品模板（用于JavaScript添加新行） -->
<template id="empty-item-template">
    <div class="item-block card mb-3">
        <div class="card-body">
            <input type="hidden" name="items-__prefix__-id" id="id_items-__prefix__-id">
            <div class="row g-2 align-items-end">
                <div class="col-md-4">
                    <label class="form-label small">物品名称</label>
                    <input type="text" name="items-__prefix__-name" class="form-control item-name" placeholder="物品名称">
                </div>
                <div class="col-md-2">
                    <label class="form-label small">数量</label>
                    <input type="number" name="items-__prefix__-quantity" class="form-control item-quantity" min="1" value="1">
                </div>
                <div class="col-md-1">
                    <label class="form-label small">单位</label>
                    <input type="text" name="items-__prefix__-unit" class="form-control item-unit" value="个">
                </div>
                <div class="col-md-2">
                    <label class="form-label small">单价(元)</label>
                    <input type="number" name="items-__prefix__-price" class="form-control item-price" step="0.01" min="0.01">
                </div>
                <div class="col-md-2">
                    <label class="form-label small">金额</label>
                    <input type="text" class="form-control item-amount" readonly placeholder="自动计算">
                </div>
                <div class="col-md-1 text-end">
                    <label class="form-label small">删除</label>
                    <div><input type="checkbox" name="items-__prefix__-DELETE" class="form-check-input"></div>
                </div>
            </div>
            <div class="mt-3 p-2 bg-light rounded">
                <label class="form-label small"><i class="bi bi-file-earmark-pdf"></i> 上传此物品的发票/凭证</label>
                <input type="file" name="item___prefix___files" class="form-control form-control-sm" multiple accept=".pdf,.jpg,.jpeg,.png">
                <small class="text-muted">支持PDF、JPG、PNG格式，可多选</small>
            </div>
        </div>
    </div>
</template>
{% endblock %}

{% block extra_js %}
<script>
// 活动主题数据
let themesData = [];

// 加载活动主题列表
fetch('{% url "get_activity_themes" %}')
    .then(response => {
        if (!response.ok) {
            throw new Error('网络请求失败');
        }
        return response.json();
    })
    .then(data => {
        themesData = data.themes || [];
        const select = document.getElementById('existing-theme-select');
        
        // 清空现有选项（除了第一个提示选项）
        select.innerHTML = '<option value="">-- 选择已有主题 --</option>';
        
        if (themesData.length === 0) {
            // 如果没有主题，显示提示
            const option = document.createElement('option');
            option.value = '';
            option.textContent = '暂无已有主题';
            option.disabled = true;
            select.appendChild(option);
        } else {
            // 添加主题选项
            themesData.forEach(theme => {
                const option = document.createElement('option');
                option.value = theme.id;
                option.textContent = theme.name;
                option.dataset.year = theme.year;
                option.dataset.month = theme.month;
                option.dataset.day = theme.day;
                select.appendChild(option);
            });
        }
    })
    .catch(error => {
        console.error('加载活动主题失败:', error);
        const select = document.getElementById('existing-theme-select');
        const option = document.createElement('option');
        option.value = '';
        option.textContent = '加载失败，请刷新页面';
        option.disabled = true;
        select.appendChild(option);
    });

// 选择已有主题时自动填充
document.getElementById('existing-theme-select').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    if (selectedOption.value) {
        document.getElementById('id_theme').value = selectedOption.textContent;
        document.getElementById('id_activity_year').value = selectedOption.dataset.year;
        document.getElementById('id_activity_month').value = selectedOption.dataset.month;
        // 更新日期选项
        updateDayOptions(selectedOption.dataset.year, selectedOption.dataset.month);
        document.getElementById('id_activity_day').value = selectedOption.dataset.day;
    }
});

// 判断是否为闰年
function isLeapYear(year) {
    return (year % 4 === 0 && year % 100 !== 0) || (year % 400 === 0);
}

// 获取指定年月的天数
function getDaysInMonth(year, month) {
    const daysInMonth = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
    if (month === 2 && isLeapYear(year)) {
        return 29;
    }
    return daysInMonth[month - 1];
}

// 更新日期下拉选项
function updateDayOptions(year, month) {
    const daySelect = document.getElementById('id_activity_day');
    const currentDay = daySelect.value;
    
    if (!year || !month) {
        daySelect.innerHTML = '<option value="">-- 请先选择年月 --</option>';
        return;
    }
    
    const yearNum = parseInt(year);
    const monthNum = parseInt(month);
    const daysInMonth = getDaysInMonth(yearNum, monthNum);
    
    // 保存当前选中的日期
    let selectedDay = currentDay;
    if (selectedDay && parseInt(selectedDay) > daysInMonth) {
        selectedDay = daysInMonth; // 如果当前日期超过该月最大天数，设为最大天数
    }
    
    // 清空并重新填充日期选项
    daySelect.innerHTML = '<option value="">-- 选择日期 --</option>';
    for (let day = 1; day <= daysInMonth; day++) {
        const option = document.createElement('option');
        option.value = day;
        option.textContent = day + '日';
        if (selectedDay && day === parseInt(selectedDay)) {
            option.selected = true;
        }
        daySelect.appendChild(option);
    }
}

// 初始化年份选项（根据当前月份动态设置）
function initializeYearOptions() {
    const now = new Date();
    const currentMonth = now.getMonth() + 1; // JavaScript月份从0开始
    const currentYear = now.getFullYear();
    
    const yearSelect = document.getElementById('id_activity_year');
    const currentYearValue = yearSelect.value;
    
    // 清空年份选项
    yearSelect.innerHTML = '<option value="">-- 选择年份 --</option>';
    
    // 如果当前是1-6月，可以选择去年和今年；如果是7-12月，只能选择今年
    if (currentMonth <= 6) {
        const option1 = document.createElement('option');
        option1.value = currentYear - 1;
        option1.textContent = (currentYear - 1) + '年';
        if (currentYearValue == currentYear - 1) option1.selected = true;
        yearSelect.appendChild(option1);
        
        const option2 = document.createElement('option');
        option2.value = currentYear;
        option2.textContent = currentYear + '年';
        if (currentYearValue == currentYear || !currentYearValue) option2.selected = true;
        yearSelect.appendChild(option2);
    } else {
        const option = document.createElement('option');
        option.value = currentYear;
        option.textContent = currentYear + '年';
        if (!currentYearValue) option.selected = true;
        yearSelect.appendChild(option);
    }
}

// 初始化月份选项（1-12月）
function initializeMonthOptions() {
    const monthSelect = document.getElementById('id_activity_month');
    const currentMonthValue = monthSelect.value;
    
    // 如果已经有选项（从Django表单生成），就不需要重新生成
    if (monthSelect.options.length > 1) {
        return;
    }
    
    monthSelect.innerHTML = '<option value="">-- 选择月份 --</option>';
    for (let month = 1; month <= 12; month++) {
        const option = document.createElement('option');
        option.value = month;
        option.textContent = month + '月';
        if (currentMonthValue == month) option.selected = true;
        monthSelect.appendChild(option);
    }
}

// 年份和月份变化时更新日期选项
document.addEventListener('DOMContentLoaded', function() {
    // 初始化年份和月份选项
    initializeYearOptions();
    initializeMonthOptions();
    
    // 如果已有选中的年月，初始化日期选项
    const yearSelect = document.getElementById('id_activity_year');
    const monthSelect = document.getElementById('id_activity_month');
    const daySelect = document.getElementById('id_activity_day');
    
    if (yearSelect.value && monthSelect.value) {
        updateDayOptions(yearSelect.value, monthSelect.value);
    }
    
    // 监听年份变化
    yearSelect.addEventListener('change', function() {
        if (this.value && monthSelect.value) {
            updateDayOptions(this.value, monthSelect.value);
        } else {
            daySelect.innerHTML = '<option value="">-- 请先选择年月 --</option>';
        }
    });
    
    // 监听月份变化
    monthSelect.addEventListener('change', function() {
        if (this.value && yearSelect.value) {
            updateDayOptions(yearSelect.value, this.value);
        } else {
            daySelect.innerHTML = '<option value="">-- 请先选择年月 --</option>';
        }
    });
});

// 添加物品行
document.getElementById('add-item').addEventListener('click', function() {
    const container = document.getElementById('items-container');
    const formIdx = document.getElementById('id_items-TOTAL_FORMS').value;
    const template = document.getElementById('empty-item-template');
    const newItem = template.content.cloneNode(true);
    
    // 替换__prefix__为实际索引
    const html = newItem.querySelector('.item-block').outerHTML.replace(/__prefix__/g, formIdx);
    container.insertAdjacentHTML('beforeend', html);
    
    document.getElementById('id_items-TOTAL_FORMS').value = parseInt(formIdx) + 1;
    
    // 绑定金额计算
    bindAmountCalculation();
});

// 绑定金额自动计算
function bindAmountCalculation() {
    document.querySelectorAll('.item-quantity, .item-price').forEach(input => {
        input.addEventListener('input', function() {
            const row = this.closest('.row');
            const qty = parseFloat(row.querySelector('.item-quantity').value) || 0;
            const price = parseFloat(row.querySelector('.item-price').value) || 0;
            row.querySelector('.item-amount').value = (qty * price).toFixed(2);
        });
    });
}

// 初始化
bindAmountCalculation();

// 表单验证
document.getElementById('reimbursement-form').addEventListener('submit', function(e) {
    if (e.submitter && e.submitter.name === 'save_draft') return true;
    
    let hasError = false;
    let errorMessages = [];
    
    function validateField(selector, fieldName) {
        const field = document.querySelector(selector);
        if (field && !field.value.trim()) {
            field.style.border = '2px solid red';
            errorMessages.push(fieldName);
            return false;
        } else if (field) {
            field.style.border = '';
        }
        return true;
    }
    
    if (!validateField('#id_theme', '活动主题')) hasError = true;
    if (!validateField('#id_activity_year', '活动年份')) hasError = true;
    if (!validateField('#id_activity_month', '活动月份')) hasError = true;
    if (!validateField('#id_activity_day', '活动日期')) hasError = true;
    if (!validateField('[name="activity_location"]', '活动地点')) hasError = true;
    if (!validateField('[name="activity_leader"]', '相关负责人')) hasError = true;
    
    // 检查至少有一个物品
    const itemBlocks = document.querySelectorAll('.item-block');
    let hasValidItem = false;
    itemBlocks.forEach(block => {
        const deleteCheck = block.querySelector('[name$="-DELETE"]');
        if (deleteCheck && deleteCheck.checked) return;
        const name = block.querySelector('.item-name');
        if (name && name.value.trim()) hasValidItem = true;
    });
    
    if (!hasValidItem) {
        errorMessages.push('至少一个物品');
        hasError = true;
    }
    
    if (hasError) {
        e.preventDefault();
        alert('请填写以下必填项：\n' + errorMessages.join('\n'));
        return false;
    }
    return true;
});
</script>
{% endblock %}
